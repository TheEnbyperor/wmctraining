(function(a){a.widget("lws.lac_select",{options:{classe:"",name:"",placeholder:"",shared:false,delay:300,minlength:1,minoptions:2,minsearch:1,showMore:false,mode:"autocomplete",required:false},_create:function(){this._setOptions();this._createStructure();this.currentIndex=-1;this.inHouse=false;this.initValue=(this.element.val()!="")?[this.element.val()]:undefined;this._manageModel();if(this.element.val().length==0){this.resList=a(this.model).lac_model("getSource");if(!jQuery.isEmptyObject(this.resList)){this._setResList(this.resList)}}this.container.on("click",".lac-select-ddbutton",this._bind(this._showHide,this));this.container.on("click",".lac-select-showmore",this._bind(this._showMore,this));this.container.on("click",".lac-select-item",this._bind(this._selectItem,this));this.container.on("focusout",".lac-select-wrapper",this._bind(this._manageFocus,this));this.textInput.on("focus",this._bind(this._manageInputFocus,this));this.element.on("change",this._bind(this._changeElement,this));this.container.on("keydown",this._bind(this._manageKeys,this));var b=this;var d;var c=[];this.container.keyup(function(e,f){c[0]=e.key;c[1]=e.keyCode;sentData=[c];d&&clearTimeout(d);d=setTimeout(b._bindD(b._manageSearch,b,sentData),b.options.delay)})},_bind:function(b,c){return function(){return b.apply(c,arguments)}},_bindD:function(b,c,d){return function(){return b.apply(c,d)}},_setOptions:function(){if(this.element.data("placeholder")!=undefined){this.options.placeholder=this.element.data("placeholder")}if(this.element.data("required")!=undefined){this.options.required=this.element.data("required")}if(this.element.data("delay")!=undefined){this.options.delay=this.element.data("delay")}if(this.element.data("class")!=undefined){this.options.classe=this.element.data("class")}if(this.element.data("name")!=undefined){this.options.name=this.element.data("name")}if(this.element.data("shared")!=undefined){this.options.shared=this.element.data("shared")}if(this.element.data("mode")!=undefined){this.options.mode=this.element.data("mode")}},_createStructure:function(){$reqborder=(this.options.required)?"lws-reqborder":"";this.container=this.element.parent();a("<div>",{"class":"lac-select-wrapper ",tabIndex:"-1","data-uuid":this.uuid}).append(a("<div>",{"class":"lac-select-combo "+$reqborder}).append(a("<input>",{"class":"lac-select-input "+this.options.classe,placeholder:this.options.placeholder,name:this.options.name})).append(a("<div>",{"class":"lac-select-showmore lws-icon-eye-plus"})).append(a("<div>",{"class":"lac-select-ddbutton lws-icon-select_arrow_down"}))).append(a("<div>",{"class":"lac-select-list","data-open":false})).append(a("<div>",{"class":"lac-select-error"})).appendTo(this.container);this.element.hide().detach().prependTo(this.container.find(".lac-select-wrapper"));this.showMoreButton=this.container.find(".lac-select-showmore");this.selectList=this.container.find(".lac-select-list");this.textInput=this.container.find(".lac-select-input");this.textInput.prop("autocomplete","off");if(this.options.required){this.textInput.lws_required()}},_manageModel:function(){if(this.options.shared){if(a("#sha-"+this.options.shared).length){this.model=a("#sha-"+this.options.shared)}else{this.model=a("<input>",{id:"sha-"+this.options.shared,type:"hidden"}).appendTo(a("body"))}}else{this.model=this.element}a(this.model).lac_model({resChange:{target:this,fn:this._resultChanged},resLoad:{target:this,fn:this._ajaxLoading},mode:"autocomplete",origin:this});if(this.initValue!=undefined){a(this.model).lac_model("returnLabels",this.initValue,this)}},_recursiveList:function(d){var b=[];for(var c in d){if(d[c].group!=undefined){retour=this._recursiveList(d[c].group);if(retour.length>0){if(retour[0][0].className!="lac-select-optgroup"){var e=a("<div>",{"class":"lac-select-optgroup","data-value":d[c].value,html:d[c].label});b.push(e)}b=a.merge(b,retour)}}else{this.selectIndex+=1;var e=a("<div>",{"class":"lac-select-item lac-item-"+this.selectIndex,"data-value":d[c].value,"data-label":d[c].label,"data-index":this.selectIndex});if(d[c].html!=undefined){e.html(d[c].html)}else{e.html(d[c].label)}b.push(e)}}return b},_setResList:function(c){this.selectList.empty();this.currentIndex=-1;this.selectIndex=-1;var d=this._recursiveList(c);for(var b=0;b<d.length;b++){d[b].appendTo(this.selectList)}this.container.find(".lac-select-item").removeClass("lac-highlighted");if(this.textInput.outerWidth()<this.selectList.outerWidth()){this.textInput.outerWidth(this.selectList.outerWidth())}},_selectItem:function(b){item=a(b.currentTarget);this._changeValue(item.data("value"));this.textInput.val(item.data("label"));this.currentIndex=item.data("index");this._closeList();this.textInput.trigger("blur")},_changeElement:function(b){if(this.inHouse===true){this.inHouse=false}else{a(this.model).lac_model("returnLabels",[this.element.val()])}},_changeValue:function(b){this.inHouse=true;this.element.val(b);this.element.trigger("change")},_showHide:function(b,c){if(!this.selectList.data("open")){this.resList=a(this.model).lac_model("getSource");if(jQuery.isEmptyObject(this.resList)&&this.textInput.val()==""){this._ajaxLoading();a(this.model).lac_model("research","",this,true)}else{this._setResList(this.resList);this._openList()}if(this.options.mode!="select"){this.textInput.focus()}}else{this._closeList()}},_showMore:function(b,c){a(this.model).lac_model("showMore",this)},_openList:function(){if(this.showMore){this.showMoreButton.show()}this.selectList.data("open",true);this.selectList.show()},_closeList:function(){this.showMoreButton.hide();this.selectList.data("open",false);this.selectList.hide()},_manageInputFocus:function(){if(this.options.mode=="select"){if(!this.selectList.data("open")){this._openList()}else{this._closeList()}this.textInput.trigger("blur")}},_manageFocus:function(b,c){if(!b.originalEvent){return}var d=a(b.originalEvent.relatedTarget);if(d.closest(".lac-select-wrapper").length>0&&!d.hasClass("lac-select-list")){if(d.closest(".lac-select-wrapper").data("uuid")==this.uuid){return}}if(this.element.val()!=""){this.element.trigger("change")}else{if(this.textInput.val()!=""){this.textInput.val("");this._showError("Incorrect Value")}}this._closeList()},_manageSearch:function(b){if(/[a-zA-Z0-9-_ ]/.test(String.fromCharCode(b[1]))){this.currentIndex=-1;a(this.model).lac_model("research",this.textInput.val(),this)}},_showError:function(b){this.container.find(".lac-select-error").html(b).show().delay(1000).fadeOut(500)},_manageKeys:function(d,e){if(d.key=="ArrowDown"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex+1>this.selectIndex)?0:this.currentIndex+1;var c=this.container.find(".lac-item-"+this.currentIndex);c.addClass("lac-highlighted");this.textInput.val(c.data("label"));this.selectList.scrollTop(Math.floor(c.position().top)+Math.floor(this.selectList.scrollTop()));this._changeValue(c.data("value"));if(this.selectList.data("open"==false)){this._openList()}}if(d.key=="ArrowUp"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex-1<0)?this.selectIndex:this.currentIndex-1;var c=this.container.find(".lac-item-"+this.currentIndex);c.addClass("lac-highlighted");this.textInput.val(c.data("label"));this.selectList.scrollTop(Math.floor(c.position().top)+Math.floor(this.selectList.scrollTop()));this._changeValue(c.data("value"));if(this.selectList.data("open"==false)){this._openList()}}if(d.key=="Enter"){this.textInput.trigger("blur")}if(d.key=="Backspace"||d.key=="Delete"||d.key=="Suppr"){this._closeList();this.currentIndex=-1;this._changeValue("");var b=this;setTimeout(function(){if(b.textInput.val().length==0){b.resList=a(b.model).lac_model("getSource");b._setResList(b.resList)}},50)}},_inputSelectRange:function(){if(this.textInput[0].setSelectionRange){var b=this.textInput.val();this.textInput.focus();var c=this.container.find(".lac-item-"+this.currentIndex);this.textInput.val(c.data("label"));this.textInput[0].setSelectionRange(b.length,this.textInput.val().length);this._changeValue(c.data("value"))}},_ajaxLoading:function(){this.textInput.addClass("lac-loading")},_resultChanged:function(b){this.textInput.removeClass("lac-loading");if(b[1]=="ok"){if(!jQuery.isEmptyObject(b[0])){this.resList=b[0];this._setResList(this.resList);this.currentIndex=0;this._inputSelectRange();this.showMore=b[2];if(!this.showMore){this.showMoreButton.hide()}this.container.find(".lac-item-"+this.currentIndex).addClass("lac-highlighted");this._openList()}else{this._closeList();this.selectList.empty()}}else{if(b[1]=="init"){if(!jQuery.isEmptyObject(b[0])){this.resList=b[0];this._setResList(this.resList);this.currentIndex=0;this.textInput.val(this.selectList.find(".lac-item-0").data("label"))}}else{if(!jQuery.isEmptyObject(b[0])){this.resList=b[0];this._setResList(this.resList);this._showError(b[1])}else{this._closeList();this.selectList.empty()}}}}})})(jQuery);jQuery(function(a){a(".lac_select").lac_select()});